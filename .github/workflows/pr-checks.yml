name: PR Checks

on:
    pull_request:
        branches: [main]
        types: [opened, synchronize, reopened, ready_for_review]

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Essential PR checks
    pr-checks:
        name: 🧪 Essential Checks
        runs-on: ubuntu-latest
        if: github.event.pull_request.draft == false

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 📦 Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: 📚 Install dependencies
              run: npm ci

            - name: 🔍 Lint
              run: npm run lint

            - name: 📝 Type Check
              run: npm run type-check

            - name: 🧪 Test
              run: npm test

            - name: 🏗️ Build
              run: npm run build

            - name: 🔒 Security Audit
              run: npm audit --audit-level=moderate
              continue-on-error: true

    # Status summary
    pr-status:
        name: ✅ PR Status
        runs-on: ubuntu-latest
        needs: [pr-checks]
        if: always()

        steps:
            - name: 🎉 Success
              if: needs.pr-checks.result == 'success'
              run: |
                  echo "## ✅ All PR Checks Passed! 🎉" >> $GITHUB_STEP_SUMMARY
                  echo "Your pull request is ready for review!" >> $GITHUB_STEP_SUMMARY

            - name: ❌ Failure
              if: needs.pr-checks.result != 'success'
              run: |
                  echo "## ❌ PR Checks Failed" >> $GITHUB_STEP_SUMMARY
                  echo "Please fix the issues before requesting review." >> $GITHUB_STEP_SUMMARY
                  exit 1
