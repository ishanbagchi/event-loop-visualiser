name: PR Checks

on:
    pull_request:
        branches: [main]
        types: [opened, synchronize, reopened, ready_for_review]

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Essential PR checks
    pr-checks:
        name: ðŸ§ª Essential Checks
        runs-on: ubuntu-latest
        if: github.event.pull_request.draft == false

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: ðŸ“š Install dependencies
              run: npm ci

            - name: ðŸ” Lint
              run: npm run lint

            - name: ðŸ“ Type Check
              run: npm run type-check

            - name: ðŸ§ª Test
              run: npm test

            - name: ðŸ—ï¸ Build
              run: npm run build

            - name: ðŸ”’ Security Audit
              run: npm audit --audit-level=moderate
              continue-on-error: true

    # Status summary
    pr-status:
        name: âœ… PR Status
        runs-on: ubuntu-latest
        needs: [pr-checks]
        if: always()

        steps:
            - name: ðŸŽ‰ Success
              if: needs.pr-checks.result == 'success'
              run: |
                  echo "## âœ… All PR Checks Passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
                  echo "Your pull request is ready for review!" >> $GITHUB_STEP_SUMMARY

            - name: âŒ Failure
              if: needs.pr-checks.result != 'success'
              run: |
                  echo "## âŒ PR Checks Failed" >> $GITHUB_STEP_SUMMARY
                  echo "Please fix the issues before requesting review." >> $GITHUB_STEP_SUMMARY
                  exit 1
